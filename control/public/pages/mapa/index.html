<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1B5E20">
    <title>Mapa de Sedes - IO Control</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <link href="../../css/styles.css" rel="stylesheet">
    <style>
        #mapaContainer {
            height: calc(100vh - 140px);
            border-radius: 8px;
            overflow: hidden;
        }

        .search-container {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sede-popup {
            min-width: 200px;
        }

        .sede-popup h6 {
            margin: 0 0 8px 0;
            color: #1B5E20;
        }

        .sede-popup p {
            margin: 4px 0;
            font-size: 13px;
        }

        .search-result-marker {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .nearby-results {
            max-height: 200px;
            overflow-y: auto;
        }

        .nearby-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .nearby-item:hover {
            background: #f5f5f5;
        }

        .nearby-item .distance {
            font-weight: bold;
            color: #1B5E20;
            margin-right: 8px;
        }

        .autocomplete-dropdown {
            position: absolute;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-recycle" style="font-size: 2rem; color: #81C784;"></i>
                <h2 style="color: white; font-size: 1.1rem; margin: 0.5rem 0 0 0;">IO Control</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="../dashboard.html" class="nav-item"><i class="bi bi-speedometer2"></i> Dashboard</a>
                <div class="nav-section">
                    <div class="nav-section-title">Clientes</div>
                </div>
                <a href="../clientes/listar.html" class="nav-item"><i class="bi bi-people"></i> Clientes</a>
                <a href="../empresas/listar.html" class="nav-item"><i class="bi bi-building"></i> Empresas</a>
                <a href="../sedes/listar.html" class="nav-item"><i class="bi bi-geo-alt"></i> Sedes</a>
                <a href="../contratos/listar.html" class="nav-item"><i class="bi bi-file-earmark-text"></i>
                    Contratos</a>
                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                </div>
                <a href="../servicios/listar.html" class="nav-item"><i class="bi bi-box-seam"></i> Servicios</a>
                <a href="../rutas/listar.html" class="nav-item"><i class="bi bi-signpost-2"></i> Rutas</a>
                <a href="../manifiestos/listar.html" class="nav-item"><i class="bi bi-journal-text"></i> Manifiestos</a>
                <a href="../guias/listar.html" class="nav-item"><i class="bi bi-file-earmark"></i> Guías</a>
                <div class="nav-section">
                    <div class="nav-section-title">Recursos</div>
                </div>
                <a href="../empleados/listar.html" class="nav-item"><i class="bi bi-person-badge"></i> Empleados</a>
                <a href="../vehiculos/listar.html" class="nav-item"><i class="bi bi-truck"></i> Vehículos</a>
                <a href="../plantas/listar.html" class="nav-item"><i class="bi bi-factory"></i> Plantas</a>
                <div class="nav-section">
                    <div class="nav-section-title">Finanzas</div>
                </div>
                <a href="../facturas/listar.html" class="nav-item"><i class="bi bi-receipt"></i> Facturas</a>
                <div class="nav-section">
                    <div class="nav-section-title">Herramientas</div>
                </div>
                <a href="index.html" class="nav-item active"><i class="bi bi-map"></i> Mapa de Sedes</a>
                <a href="../reportes/index.html" class="nav-item"><i class="bi bi-graph-up"></i> Reportes</a>
                <a href="../alertas/index.html" class="nav-item"><i class="bi bi-bell"></i> Alertas</a>
            </nav>
        </aside>

        <main class="main-content">
            <nav class="top-nav">
                <div class="breadcrumb-container">
                    <button class="toggle-sidebar" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="../dashboard.html">Dashboard</a></li>
                            <li class="breadcrumb-item active">Mapa de Sedes</li>
                        </ol>
                    </nav>
                </div>
                <div class="user-menu">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="userName">Usuario</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                        class="bi bi-box-arrow-right"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="content-area">
                <div class="row g-3">
                    <!-- Search Panel -->
                    <div class="col-lg-4">
                        <div class="search-container">
                            <h6><i class="bi bi-search"></i> Buscar Ubicación</h6>
                            <div class="position-relative">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="addressSearch"
                                        placeholder="Escribe una dirección...">
                                    <button class="btn btn-primary" id="btnSearch"><i class="bi bi-search"></i></button>
                                </div>
                                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                            </div>
                            <small class="text-muted"><i class="bi bi-info-circle"></i> También puedes hacer clic en el
                                mapa</small>
                            <button class="btn btn-outline-secondary btn-sm w-100 mt-2 d-none" id="btnClearSearch">
                                <i class="bi bi-x-circle"></i> Limpiar búsqueda
                            </button>
                            <div id="nearbyResults" class="nearby-results mt-3"></div>
                        </div>
                        <div class="search-container mt-3">
                            <h6><i class="bi bi-geo-alt-fill text-danger"></i> Resumen</h6>
                            <p class="mb-1">Sedes en mapa: <strong id="sedesCount">0</strong></p>
                        </div>
                    </div>
                    <!-- Map -->
                    <div class="col-lg-8">
                        <div id="mapaContainer"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/app.js"></script>
    <script>
        initPage('mapa');

        let map, sedesData = {}, markersGroup;
        let searchMarker, searchCircle;
        let debounceTimer;

        // Initialize map
        map = L.map('mapaContainer', {
            preferCanvas: true,
            renderer: L.canvas()
        }).setView([-12.0464, -77.0428], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        markersGroup = L.featureGroup().addTo(map);

        // Load sedes
        async function loadSedes() {
            try {
                const result = await api.get('/sedes?mapa=1');
                if (result.success && result.data) {
                    result.data.forEach(sede => {
                        if (sede.coordenadas_gps) {
                            const parts = sede.coordenadas_gps.split(',');
                            if (parts.length === 2) {
                                const lat = parseFloat(parts[0].trim());
                                const lng = parseFloat(parts[1].trim());
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    sedesData[sede.id_sede] = { ...sede, lat, lng };
                                    const marker = L.circleMarker([lat, lng], {
                                        radius: 8,
                                        fillColor: '#D32F2F',
                                        color: '#fff',
                                        weight: 2,
                                        fillOpacity: 0.9
                                    });
                                    marker.on('click', () => {
                                        marker.bindPopup(`
                                            <div class="sede-popup">
                                                <h6>${sede.nombre_comercial}</h6>
                                                <p><i class="bi bi-building"></i> ${sede.empresa_razon_social || '-'}</p>
                                                <p><i class="bi bi-geo-alt"></i> ${sede.direccion || '-'}</p>
                                                <p><i class="bi bi-pin-map"></i> ${sede.distrito || ''}, ${sede.provincia || ''}</p>
                                            </div>
                                        `).openPopup();
                                    });
                                    markersGroup.addLayer(marker);
                                }
                            }
                        }
                    });
                    document.getElementById('sedesCount').textContent = Object.keys(sedesData).length;
                    if (markersGroup.getLayers().length > 0) {
                        map.fitBounds(markersGroup.getBounds().pad(0.1));
                    }
                }
            } catch (err) {
                console.error('Error loading sedes:', err);
            }
        }

        // Haversine distance calculation
        function calcDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // Find nearby clients
        function findNearbyClients(lat, lng, radiusKm = 1) {
            const nearby = [];
            Object.values(sedesData).forEach(sede => {
                const dist = calcDistance(lat, lng, sede.lat, sede.lng);
                if (dist <= radiusKm) {
                    nearby.push({ ...sede, distance: dist });
                }
            });
            return nearby.sort((a, b) => a.distance - b.distance);
        }

        // Show nearby results
        function showNearbyResults(nearby) {
            const container = document.getElementById('nearbyResults');
            if (nearby.length === 0) {
                container.innerHTML = '<div class="alert alert-info mb-0 py-2"><i class="bi bi-info-circle"></i> No hay clientes en un radio de 1 km</div>';
            } else {
                container.innerHTML = `
                    <div class="text-muted small mb-2"><i class="bi bi-check-circle text-success"></i> ${nearby.length} cliente(s) en radio de 1 km:</div>
                    ${nearby.slice(0, 10).map(s => `
                        <div class="nearby-item" onclick="zoomToSede(${s.lat}, ${s.lng}, ${s.id_sede})">
                            <span class="distance">${s.distance < 1 ? (s.distance * 1000).toFixed(0) + ' m' : s.distance.toFixed(2) + ' km'}</span>
                            <span>${s.nombre_comercial}</span>
                        </div>
                    `).join('')}
                `;
            }
        }

        function zoomToSede(lat, lng, id) {
            map.setView([lat, lng], 16);
        }

        // Search location
        function searchLocation(lat, lng) {
            if (searchMarker) map.removeLayer(searchMarker);
            if (searchCircle) map.removeLayer(searchCircle);

            searchMarker = L.circleMarker([lat, lng], {
                radius: 12,
                fillColor: '#2563eb',
                color: '#fff',
                weight: 3,
                fillOpacity: 1,
                className: 'search-result-marker'
            }).addTo(map);

            searchCircle = L.circle([lat, lng], {
                radius: 1000,
                color: '#2563eb',
                fillColor: '#2563eb',
                fillOpacity: 0.1,
                dashArray: '5, 10'
            }).addTo(map);

            map.setView([lat, lng], 14);
            showNearbyResults(findNearbyClients(lat, lng, 1));
            document.getElementById('btnClearSearch').classList.remove('d-none');
        }

        // Autocomplete search
        document.getElementById('addressSearch').addEventListener('input', function () {
            clearTimeout(debounceTimer);
            const query = this.value.trim();
            if (query.length < 3) {
                document.getElementById('autocompleteDropdown').style.display = 'none';
                return;
            }
            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Lima, Peru')}&limit=5`,
                        { headers: { 'User-Agent': 'IOControl-Map' } }
                    );
                    const data = await response.json();
                    const dropdown = document.getElementById('autocompleteDropdown');
                    if (data.length > 0) {
                        dropdown.innerHTML = data.map(r => `
                            <div class="autocomplete-item" onclick="selectAddress(${r.lat}, ${r.lon}, '${r.display_name.replace(/'/g, "\\'")}')">
                                <i class="bi bi-geo-alt text-primary"></i> ${r.display_name.substring(0, 60)}...
                            </div>
                        `).join('');
                        dropdown.style.display = 'block';
                    } else {
                        dropdown.style.display = 'none';
                    }
                } catch (e) { console.error(e); }
            }, 300);
        });

        function selectAddress(lat, lng, name) {
            document.getElementById('addressSearch').value = name.substring(0, 50);
            document.getElementById('autocompleteDropdown').style.display = 'none';
            searchLocation(lat, lng);
        }

        // Click on map
        map.on('click', function (e) {
            searchLocation(e.latlng.lat, e.latlng.lng);
        });

        // Clear search
        document.getElementById('btnClearSearch').addEventListener('click', function () {
            if (searchMarker) map.removeLayer(searchMarker);
            if (searchCircle) map.removeLayer(searchCircle);
            document.getElementById('addressSearch').value = '';
            document.getElementById('nearbyResults').innerHTML = '';
            this.classList.add('d-none');
            if (markersGroup.getLayers().length > 0) {
                map.fitBounds(markersGroup.getBounds().pad(0.1));
            }
        });

        // Search button
        document.getElementById('btnSearch').addEventListener('click', async function () {
            const query = document.getElementById('addressSearch').value.trim();
            if (!query) return;
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Lima, Peru')}&limit=1`,
                    { headers: { 'User-Agent': 'IOControl-Map' } }
                );
                const data = await response.json();
                if (data.length > 0) {
                    searchLocation(parseFloat(data[0].lat), parseFloat(data[0].lon));
                }
            } catch (e) { console.error(e); }
        });

        // Load on start
        loadSedes();
    </script>
</body>

</html>